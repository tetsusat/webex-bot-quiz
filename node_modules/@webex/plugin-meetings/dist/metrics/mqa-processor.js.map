{"version":3,"sources":["mqa-processor.js"],"names":["MQAProcessor","data","videoReceive","audioTransmit","audioReceive","videoTransmit","intervalNumber","id","interval","rtcCandidatePair","rtcOutVideo","rtpOutVideo","vsTransmit","sumValue","STATS","AUDIO_SENDER_ID","push","AUDIO_RECEIVER_ID","VIDEO_SENDER_ID","VIDEO_RECEIVER_ID","SHARE_SENDER_ID","MQA_STATS","DEFAULT_SHARE_SENDER_STATS","bowser","name","toLowerCase","common","remoteLossRate","pliCount","length","rtpPackets","packetsSent","streams","transmittedFrameRate","framesEncoded","availableBitRate","availableOutgoingBitrate","roundTripTime","totalRoundTripTime","transmittedBitrate","framesSent","transmittedHeight","frameHeight","transmittedKeyFrames","hugeFramesSent","transmittedWidth","frameWidth","intervalMetadata","payload"],"mappings":"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","sourcesContent":["import bowser from 'bowser';\n\nimport {\n  STATS,\n  MQA_STATS\n} from '../constants';\n\n\n/**\n * @description MQAProcessor handles interval data for MQA\n * @export\n * @class MQAProcessor\n */\nclass MQAProcessor {\n  /**\n     * @constructor\n     * @public\n     * @memberof MQAProcessor\n     */\n  constructor() {\n    this.data = {\n      videoReceive: [],\n      audioTransmit: [],\n      audioReceive: [],\n      videoTransmit: []\n    };\n    this.intervalNumber = 1;\n  }\n\n  /**\n   * @param {String} id\n   * @param {Array<WebRTCData>} interval - a slice of metrics history\n   * @returns {undefined}\n   * @memberof MQAProcessor\n   */\n  process(id, interval) {\n    let rtcCandidatePair, rtcOutVideo, rtpOutVideo; // TODO: , rtcInVideo, rtpInVideo, rtcOutAudio, rtcInAudio, rtpInAudio, rtpOutAudio; // TODO:\n    let vsTransmit;\n\n    const {\n      videoReceive, audioTransmit, audioReceive, videoTransmit\n    } = this.data;\n\n    const sumValue = interval[0]; // the head is the last interval value, webRTC spec has some values automatically summed\n\n    if (sumValue) {\n      rtcCandidatePair = sumValue.rtcCandidatePair;\n    }\n\n    switch (id) {\n      case STATS.AUDIO_SENDER_ID:\n        audioTransmit.push();\n        break;\n      case STATS.AUDIO_RECEIVER_ID:\n        audioReceive.push();\n        break;\n      case STATS.VIDEO_SENDER_ID:\n        videoTransmit.push();\n        break;\n      case STATS.VIDEO_RECEIVER_ID:\n        videoReceive.push();\n        break;\n      case STATS.SHARE_SENDER_ID:\n        if (sumValue) {\n          rtcOutVideo = sumValue.rtcOutVideo;\n          rtpOutVideo = sumValue.rtpOutVideo;\n        }\n        vsTransmit = {...MQA_STATS.DEFAULT_SHARE_SENDER_STATS};\n        if (bowser.name.toLowerCase() === 'firefox') {\n          vsTransmit.common.remoteLossRate = rtpOutVideo ? rtpOutVideo.pliCount / (interval.length * this.intervalNumber) : 0;\n          vsTransmit.common.rtpPackets = rtpOutVideo ? rtpOutVideo.packetsSent / (interval.length * this.intervalNumber) : 0;\n          vsTransmit.streams[0].common.transmittedFrameRate = rtcOutVideo ? rtcOutVideo.framesEncoded / (interval.length * this.intervalNumber) : 0;\n          vsTransmit.streams[0].common.rtpPackets = rtpOutVideo ? rtpOutVideo.packetsSent / (interval.length * this.intervalNumber) : 0;\n        }\n        else {\n          vsTransmit.common.availableBitRate = rtcCandidatePair ? rtcCandidatePair.availableOutgoingBitrate : 0;\n          vsTransmit.common.remoteLossRate = rtpOutVideo ? rtpOutVideo.pliCount / (interval.length * this.intervalNumber) : 0;\n          vsTransmit.common.roundTripTime = rtcCandidatePair ? rtcCandidatePair.totalRoundTripTime / (interval.length * this.intervalNumber) : 0;\n          vsTransmit.common.rtpPackets = rtpOutVideo ? rtpOutVideo.packetsSent / (interval.length * this.intervalNumber) : 0;\n          vsTransmit.streams[0].common.rtpPackets = rtpOutVideo ? rtpOutVideo.packetsSent / (interval.length * this.intervalNumber) : 0;\n          vsTransmit.streams[0].common.transmittedBitrate = rtcCandidatePair ? rtcCandidatePair.availableOutgoingBitrate : 0;\n          vsTransmit.streams[0].common.transmittedFrameRate = rtcOutVideo ? rtcOutVideo.framesSent / (interval.length * this.intervalNumber) : 0;\n          vsTransmit.streams[0].transmittedHeight = rtcOutVideo ? rtcOutVideo.frameHeight : 0;\n          vsTransmit.streams[0].transmittedKeyFrames = rtcOutVideo ? rtcOutVideo.hugeFramesSent : 0;\n          vsTransmit.streams[0].transmittedWidth = rtcOutVideo ? rtcOutVideo.frameWidth : 0;\n        }\n        videoTransmit.push(vsTransmit);\n        break;\n      default:\n        break;\n    }\n    this.data.intervalMetadata = this.data.intervalMetadata || {...MQA_STATS.intervalMetadata};\n  }\n\n  /**\n   * get the data payload for media quality events after they all have been processed\n   * wait to call this until after you have all the data from the interval you want\n   * this method clears the data as a side effect\n   * @returns {Object}\n   * @memberof MQAProcessor\n   */\n  getData() {\n    this.intervalNumber += 1;\n\n    const payload = {...this.data, intervalNumber: this.intervalNumber};\n\n    this.data = {\n      videoReceive: [],\n      audioTransmit: [],\n      audioReceive: [],\n      videoTransmit: []\n    };\n\n    return payload;\n  }\n}\n\nexport default MQAProcessor;\n"]}